<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/filter.css">
<link rel="stylesheet" href="css/nouislider.min.css">
        <link rel="stylesheet" href="css/leaflet-control-geocoder.Geocoder.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title></title>
        <!-- Add Tabletop.js library before closing </head> tag -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/multi-style-layer.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/tailDT.js"></script>
        <link rel="stylesheet" href="https://daniellsu.github.io/leaflet-betterscale/L.Control.BetterScale.css"/>
        <script src="https://daniellsu.github.io/leaflet-betterscale/L.Control.BetterScale.js"></script>
<script src="js/nouislider.min.js"></script>
<script src="js/wNumb.js"></script>
        <script>
var highlightLayer;
var sheetsData = []; // Store fetched data
var json_Form_Pengaduan_Jalan_Rusak_3 = { type: 'FeatureCollection', features: [] }; // Initialize empty GeoJSON
var map; // Declare map globally

// ============================================
// COORDINATE VALIDATION AND REVERSE GEOCODING
// ============================================

/**
 * Validates if a coordinate value is coherent (within valid ranges)
 * @param {number} lat - Latitude value
 * @param {number} lon - Longitude value
 * @returns {boolean} - True if coordinates are valid
 */
function isValidCoordinate(lat, lon) {
    // Check if values are numbers and within valid ranges
    // Latitude: -90 to 90, Longitude: -180 to 180
    if (isNaN(lat) || isNaN(lon)) return false;
    if (lat < -90 || lat > 90) return false;
    if (lon < -180 || lon > 180) return false;
    // Additional check: coordinates should not be exactly 0,0 unless intentional
    if (lat === 0 && lon === 0) return false;
    return true;
}

/**
 * Performs reverse geocoding using OpenStreetMap Nominatim API
 * Gets the location name (Koordinat Jalan Rusak) from latitude/longitude
 * @param {number} lat - Latitude coordinate
 * @param {number} lon - Longitude coordinate
 * @returns {Promise<string>} - Returns location address/name
 */
function reverseGeocode(lat, lon) {
    return new Promise((resolve, reject) => {
        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
        
        fetch(nominatimUrl, {
            headers: {
                'Accept': 'application/json',
                'User-Agent': 'qgis2web-app'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Extract the most appropriate address components
            const address = data.address || {};
            let locationName = data.name || '';
            
            // Build a detailed address from available components
            const addressParts = [];
            
            // Priority order for building the address
            if (address.road) addressParts.push(address.road);
            if (address.village) addressParts.push(address.village);
            if (address.town) addressParts.push(address.town);
            if (address.city) addressParts.push(address.city);
            if (address.county) addressParts.push(address.county);
            if (address.state) addressParts.push(address.state);
            
            locationName = addressParts.length > 0 
                ? addressParts.join(', ') 
                : `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
            
            console.log(`Reverse geocoded: ${locationName}`);
            resolve(locationName);
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
            // Fallback to coordinates if API fails
            resolve(`Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`);
        });
    });
}

/**
 * Converts Degree Minute Second (DMS) format to Decimal Degree
 * Supports formats like: 115¬∞25'23.5", 115 25 23.5, 115¬∞25'23.5"E, etc.
 * @param {string} dmsString - DMS coordinate string
 * @returns {number|null} - Decimal degree or null if invalid
 */
function convertDMSToDecimal(dmsString) {
    if (!dmsString || typeof dmsString !== 'string') return null;
    
    dmsString = dmsString.trim();
    
    // Extract cardinal direction (E, W, N, S)
    const cardinalMatch = dmsString.match(/[EWNS]/i);
    const cardinal = cardinalMatch ? cardinalMatch[0].toUpperCase() : null;
    
    // Remove cardinal direction and common separators
    let cleaned = dmsString.replace(/[EWNS¬∞'"]/gi, ' ').trim();
    
    // Extract numbers (handles various separators: space, comma, etc.)
    const numbers = cleaned.match(/-?\d+\.?\d*/g);
    
    if (!numbers || numbers.length < 1) return null;
    
    let degrees = parseFloat(numbers[0]);
    let minutes = numbers.length > 1 ? parseFloat(numbers[1]) : 0;
    let seconds = numbers.length > 2 ? parseFloat(numbers[2]) : 0;
    
    // Validate ranges
    if (minutes < 0 || minutes >= 60 || seconds < 0 || seconds >= 60) {
        return null;
    }
    
    // Calculate decimal degree
    let decimal = degrees + (minutes / 60) + (seconds / 3600);
    
    // Apply cardinal direction sign
    if (cardinal === 'S' || cardinal === 'W') {
        decimal = -Math.abs(decimal);
    } else if (cardinal === 'N' || cardinal === 'E') {
        decimal = Math.abs(decimal);
    }
    
    return decimal;
}

/**
 * Handles coordinate parsing with support for both decimal and DMS formats
 * Applies cardinal direction (E/W for longitude, N/S for latitude)
 * @param {string} coordString - Coordinate string
 * @param {string} type - Either 'longitude' or 'latitude'
 * @returns {number|null} - Decimal degree or null if invalid
 */
function parseCoordinate(coordString, type) {
    if (!coordString || typeof coordString !== 'string') return null;
    
    coordString = coordString.trim();
    
    // Try to convert DMS to decimal first
    let decimal = convertDMSToDecimal(coordString);
    
    // If DMS conversion failed, try parsing as simple decimal
    if (decimal === null) {
        decimal = parseFloat(coordString);
        if (isNaN(decimal)) return null;
    }
    
    // Apply cardinal direction logic if not already applied
    if (decimal !== null) {
        const cardinalMatch = coordString.match(/[EWNS]/i);
        if (cardinalMatch) {
            const cardinal = cardinalMatch[0].toUpperCase();
            if (cardinal === 'S' || cardinal === 'W') {
                decimal = -Math.abs(decimal);
            } else if (cardinal === 'N' || cardinal === 'E') {
                decimal = Math.abs(decimal);
            }
        }
    }
    
    return decimal;
}

/**
 * Updated: Extracts valid coordinates from row data with DMS support
 * @param {Object} row - Data row from Google Sheets
 * @returns {Object|null} - {lat, lon} or null
 */
function extractValidCoordinates(row) {
    const lonString = row['Koordinat X (Longitude)'];
    const latString = row['Koordinat Y (Latitude)'];
    
    const lon = parseCoordinate(lonString, 'longitude');
    const lat = parseCoordinate(latString, 'latitude');
    
    if (lon !== null && lat !== null && isValidCoordinate(lat, lon)) {
        return { lat: lat, lon: lon };
    }
    return null;
}

/**
 * Attempts to extract coordinates from "Koordinat Jalan Rusak" field
 * Supports various formats: "lat,lon" or "lon,lat"
 * @param {string} koordinatText - Text containing coordinates
 * @returns {Object|null} - {lat, lon} or null
 */
function parseKordinatJalanRusakField(koordinatText) {
    if (!koordinatText || typeof koordinatText !== 'string') return null;
    
    // Remove common separators and whitespace
    koordinatText = koordinatText.trim();
    
    // Try to extract numbers (handles formats like "1.23, 4.56" or "1.23,4.56")
    const numberPattern = /-?\d+\.?\d*/g;
    const numbers = koordinatText.match(numberPattern);
    
    if (!numbers || numbers.length < 2) return null;
    
    const num1 = parseFloat(numbers[0]);
    const num2 = parseFloat(numbers[1]);
    
    // Determine which is latitude and which is longitude
    // Longitude typically larger absolute values for this region, or check ranges
    let lat, lon;
    
    // Check if first number looks like longitude and second like latitude (for this region)
    if (Math.abs(num1) > 10 && Math.abs(num2) < 10) {
        lon = num1;
        lat = num2;
    } else {
        lat = num1;
        lon = num2;
    }
    
    if (isValidCoordinate(lat, lon)) {
        return { lat: lat, lon: lon };
    }
    
    return null;
}

/**
 * Gets location name with fallback to reverse geocoding
 * Caches results to avoid excessive API calls
 * @param {Object} row - Data row from Google Sheets
 * @returns {Promise<string>} - Location name/address
 */
const locationCache = {}; // Cache for reverse geocoding results

async function getLocationName(row) {
    // First, try to get valid coordinates from primary fields
    let coords = extractValidCoordinates(row);
    
    // If primary coordinates are invalid, try to parse "Koordinat Jalan Rusak" field
    if (!coords && row['Koordinat Jalan Rusak']) {
        coords = parseKordinatJalanRusakField(row['Koordinat Jalan Rusak']);
    }
    
    // If we have valid coordinates, perform reverse geocoding
    if (coords) {
        const cacheKey = `${coords.lat.toFixed(4)}_${coords.lon.toFixed(4)}`;
        
        if (locationCache[cacheKey]) {
            return locationCache[cacheKey];
        }
        
        const locationName = await reverseGeocode(coords.lat, coords.lon);
        locationCache[cacheKey] = locationName;
        return locationName;
    }
    
    // Fallback if no coordinates found
    return 'Koordinat tidak tersedia';
}

// ============================================
// END
// ============================================

// Fetch Google Sheets data using Papa Parse
function init() {
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQAcHzBsovW-FFQpcikrjdg9RNxDKaE3MTB0CkBgJVsj6aYzMuExNJB77sRIDKztKVPRtE1MoidxVX-/pub?output=csv';
    
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: myFunction,
        error: function(error) {
            console.error('Error fetching data:', error);
        }
    });
}

// Process fetched data and convert to GeoJSON with coordinate validation
async function myFunction(results) {
    console.log('Fetched data:', results.data);
    sheetsData = results.data.filter(row => {
        // Include rows that have either primary coordinates or can be parsed
        const hasValidCoords = extractValidCoordinates(row);
        const hasKordinatField = row['Koordinat Jalan Rusak'];
        return hasValidCoords || hasKordinatField;
    });
    
    // Convert sheet data to GeoJSON format with coordinate validation
    const features = [];
    
    for (const row of sheetsData) {
        let coords = extractValidCoordinates(row);
        let locationName = '';
        
        // If primary coordinates are invalid, try to parse them
        if (!coords && row['Koordinat Jalan Rusak']) {
            coords = parseKordinatJalanRusakField(row['Koordinat Jalan Rusak']);
        }
        
        // If we found valid coordinates, perform reverse geocoding to get location name
        if (coords) {
            try {
                locationName = await getLocationName(row);
            } catch (error) {
                console.error('Error getting location name:', error);
                locationName = `Lat: ${coords.lat.toFixed(6)}, Lon: ${coords.lon.toFixed(6)}`;
            }
            
            features.push({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [coords.lon, coords.lat]
                },
                properties: {
                    'Submission ID': row['Submission ID'] || '',
                    'Status Progress': row['Status Progress'] || '',
                    'Skala Prioritas': row['Skala Prioritas'] || '',
                    'Alasan Urgensi': row['Alasan Urgensi'] || '',
                    'Alasan Tertunda': row['Alasan Tertunda'] || '',
                    'Kebutuhan Alat Berat': row['Kebutuhan Alat Berat'] || '',
                    'Koordinat X (Longitude)': row['Koordinat X (Longitude)'] || coords.lon.toFixed(6),
                    'Koordinat Y (Latitude)': row['Koordinat Y (Latitude)'] || coords.lat.toFixed(6),
                    'Koordinat Jalan Rusak': locationName, // Reverse geocoded location name
                    'Dokumentasi Jalan Rusak': row['Dokumentasi Jalan Rusak'] || ''
                }
            });
        }
    }
    
    json_Form_Pengaduan_Jalan_Rusak_3.features = features;
    
    console.log('GeoJSON features:', json_Form_Pengaduan_Jalan_Rusak_3.features.length);
    
    // Reinitialize the layer with new data
    if (window.layer_Form_Pengaduan_Jalan_Rusak_3) {
        map.removeLayer(layer_Form_Pengaduan_Jalan_Rusak_3);
    }
    
    initializeLayer();
}

function highlightFeature(e) {
    highlightLayer = e.target;

    if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
      highlightLayer.setStyle({
        color: '#ffff00',
      });
    // } else {
    //   highlightLayer.setStyle({
    //     fillColor: '#ffff00',
    //     fillOpacity: 1
    //   });
    }
    highlightLayer.openPopup();
}

map = L.map('map', {
    zoomControl:false, maxZoom:28, minZoom:1
}).fitBounds([[-2.1700457295648454,115.36414172244884],[-2.1315699495648466,115.4283555668857]]);

// Close popups when clicking on map background
map.on('click', function(e) {
    map.closePopup();
});

map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

// remove popup's row if "visible-with-data"
function removeEmptyRowsFromPopupContent(content, feature) {
 var tempDiv = document.createElement('div');
 tempDiv.innerHTML = content;
 var rows = tempDiv.querySelectorAll('tr');
 for (var i = 0; i < rows.length; i++) {
     var td = rows[i].querySelector('td.visible-with-data');
     var key = td ? td.id : '';
     if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
         rows[i].parentNode.removeChild(rows[i]);
     }
 }
 return tempDiv.innerHTML;
}

//Add scale with var options={metric:true}
var scale = L.control.betterscale({metric:true,imperial:false}).addTo(map)

// add class to format popup if it contains media
function addClassToPopupIfMedia(content, popup) {
    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    if (tempDiv.querySelector('td img')) {
        popup._contentNode.classList.add('media');
        // Delay to force the redraw
        setTimeout(function() {
            popup.update();
        }, 10);
    } else {
        popup._contentNode.classList.remove('media');
    }
}

var zoomControl = L.control.zoom({
    position: 'topleft'
}).addTo(map);

L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);

var measureControl = new L.Control.Measure({
    position: 'topleft',
    primaryLengthUnit: 'meters',
    secondaryLengthUnit: 'kilometers',
    primaryAreaUnit: 'sqmeters',
    secondaryAreaUnit: 'hectares'
});

measureControl.addTo(map);
document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

var bounds_group = new L.featureGroup([]);

function setBounds() {
    // Remove or comment out map.setMaxBounds to allow free navigation
    // map.setMaxBounds(map.getBounds());
}

map.createPane('pane_GoogleSatelliteHybrid_0');
map.getPane('pane_GoogleSatelliteHybrid_0').style.zIndex = 400;
var layer_GoogleSatelliteHybrid_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    pane: 'pane_GoogleSatelliteHybrid_0',
    opacity: 1.0,
    attribution: '',
    minZoom: 1,
    maxZoom: 28,
    minNativeZoom: 0,
    maxNativeZoom: 19
});
layer_GoogleSatelliteHybrid_0;
map.addLayer(layer_GoogleSatelliteHybrid_0);

map.createPane('pane_ESRI_1');
map.getPane('pane_ESRI_1').style.zIndex = 401;
var layer_ESRI_1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    pane: 'pane_ESRI_1',
    opacity: 1.0,
    attribution: '',
    minZoom: 1,
    maxZoom: 28,
    minNativeZoom: 0,
    maxNativeZoom: 18
});
layer_ESRI_1;
map.addLayer(layer_ESRI_1);

map.createPane('pane_OpenStreetMap_2');
map.getPane('pane_OpenStreetMap_2').style.zIndex = 402;
var layer_OpenStreetMap_2 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    pane: 'pane_OpenStreetMap_2',
    opacity: 1.0,
    attribution: '',
    minZoom: 1,
    maxZoom: 28,
    minNativeZoom: 0,
    maxNativeZoom: 19
});
layer_OpenStreetMap_2;
map.addLayer(layer_OpenStreetMap_2);

function decimalToDMS(decimal, type) {
    if (decimal === null || typeof decimal === 'undefined' || isNaN(decimal)) return '';
    var sign = decimal < 0 ? -1 : 1;
    var abs = Math.abs(decimal);
    var degrees = Math.floor(abs);
    var minutesFloat = (abs - degrees) * 60;
    var minutes = Math.floor(minutesFloat);
    var seconds = (minutesFloat - minutes) * 60;
    // Round seconds to 3 decimal places
    seconds = Math.round(seconds * 1000) / 1000;
    var dir = '';
    if (type === 'longitude' || type === 'lon' || type === 'x') {
        dir = (sign >= 0) ? 'E' : 'W';
    } else {
        dir = (sign >= 0) ? 'N' : 'S';
    }
    // Zero-pad minutes and seconds for nicer formatting
    var minutesStr = String(minutes).padStart(2, '0');
    var secondsStr = (seconds < 10 ? '0' : '') + seconds.toFixed(3);
    return degrees + '¬∞ ' + minutesStr + "' " + secondsStr + '" ' + dir;
}

function pop_Form_Pengaduan_Jalan_Rusak_3(feature, layer) {
    layer.on({
        click: function(e) {
            highlightFeature(e);
            layer.openPopup();
        },
    });
    
    // Helper function to check if string is a URL
    function isUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }
    
    // Helper function to format field values
    function formatFieldValue(value) {
        if (!value) return '';
        const strValue = String(value).trim();
        if (isUrl(strValue)) {
            return autolinker.link(strValue.replace(/'/g, '\''));
        }
        return strValue.replace(/'/g, '\'');
    }
    
    // Parse and extract valid coordinates
    var rawLon = feature.properties['Koordinat X (Longitude)'];
    var rawLat = feature.properties['Koordinat Y (Latitude)'];

    // Use parseCoordinate (supports DMS & cardinal) to try get decimal values
    var parsedLon = parseCoordinate(String(rawLon || ''), 'longitude');
    var parsedLat = parseCoordinate(String(rawLat || ''), 'latitude');

    // Fallback to geometry coords if parsing failed
    if ((!parsedLon || isNaN(parsedLon)) && feature.geometry && Array.isArray(feature.geometry.coordinates)) {
        parsedLon = feature.geometry.coordinates[0];
    }
    if ((!parsedLat || isNaN(parsedLat)) && feature.geometry && Array.isArray(feature.geometry.coordinates)) {
        parsedLat = feature.geometry.coordinates[1];
    }

    // Convert decimal to DMS with orientation
    var displayLonDMS = parsedLon !== null && !isNaN(parsedLon) ? decimalToDMS(parsedLon, 'longitude') : '';
    var displayLatDMS = parsedLat !== null && !isNaN(parsedLat) ? decimalToDMS(parsedLat, 'latitude') : '';
    
    // Handle documentation links separately
    const docLink = feature.properties['Dokumentasi Jalan Rusak'] ?
        '<a href="' + String(feature.properties['Dokumentasi Jalan Rusak']).trim() + '" target="_blank" style="color: #0078d4; text-decoration: underline;">Open Link</a>' : '';
    
    var popupContent = '<table>\
            <tr>\
                <th scope="row">Submission ID</th>\
                <td class="visible-with-data" id="Submission ID">' + (feature.properties['Submission ID'] !== null ? formatFieldValue(feature.properties['Submission ID']) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Skala Prioritas</th>\
                <td class="visible-with-data" id="Skala Prioritas">' + (feature.properties['Skala Prioritas'] !== null ? formatFieldValue(feature.properties['Skala Prioritas']) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Alasan Urgensi</th>\
                <td class="visible-with-data" id="Alasan Urgensi">' + (feature.properties['Alasan Urgensi'] !== null ? formatFieldValue(feature.properties['Alasan Urgensi']) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Kebutuhan Alat Berat</th>\
                <td class="visible-with-data" id="Kebutuhan Alat Berat">' + (feature.properties['Kebutuhan Alat Berat'] !== null ? formatFieldValue(feature.properties['Kebutuhan Alat Berat']) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Koordinat Jalan Rusak</th>\
                <td class="visible-with-data" id="Koordinat Jalan Rusak">' + (feature.properties['Koordinat Jalan Rusak'] !== null ? formatFieldValue(feature.properties['Koordinat Jalan Rusak']) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Koordinat X (Longitude)</th>\
                <td class="visible-with-data" id="Koordinat X (Longitude)">' + (displayLonDMS ? formatFieldValue(displayLonDMS) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Koordinat Y (Latitude)</th>\
                <td class="visible-with-data" id="Koordinat Y (Latitude)">' + (displayLatDMS ? formatFieldValue(displayLatDMS) : '') + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Dokumentasi Jalan Rusak</th>\
                <td class="visible-with-data" id="Dokumentasi Jalan Rusak">' + docLink + '</td>\
            </tr>\
            <tr>\
                <th scope="row">Status Progress</th>\
                <td class="visible-with-data" id="Status Progress" style="color: ' + (function() { var val = feature.properties['Status Progress']; if (val === 'Ditunda') return '#b10202'; else if (val === 'Laporan Diterima') return '#0a53a8'; else if (val === 'Dalam Pengerjaan') return '#cf9a10'; else if (val === 'Selesai') return '#11734b'; else return 'inherit'; })() + ';">' + (feature.properties['Status Progress'] !== null ? formatFieldValue(feature.properties['Status Progress']) : '') + '</td>\
            </tr>' +
            (feature.properties['Alasan Tertunda'] ? '<tr>\
                <th scope="row" style="color: #b10202;">Alasan Tertunda</th>\
                <td style="color: #b10202;">' + formatFieldValue(feature.properties['Alasan Tertunda']) + '</td>\
            </tr>' : '') +
        '</table>';
    var content = removeEmptyRowsFromPopupContent(popupContent, feature);
    layer.on('popupopen', function(e) {
        addClassToPopupIfMedia(content, e.popup);
    });
    layer.bindPopup(content, { maxHeight: 400, maxWidth: 300 });
}

function style_Form_Pengaduan_Jalan_Rusak_3_0() {
    return {
        pane: 'pane_Form_Pengaduan_Jalan_Rusak_3',
        radius: 13.2,
        opacity: 1,
        color: 'rgba(184,8,8,1.0)',
        dashArray: '',
        lineCap: 'butt',
        lineJoin: 'miter',
        weight: 1.0,
        fill: true,
        fillOpacity: 1,
        fillColor: 'rgba(184,8,8,1.0)',
        interactive: true,
    }
}

function style_Form_Pengaduan_Jalan_Rusak_3_1() {
    return {
        pane: 'pane_Form_Pengaduan_Jalan_Rusak_3',
        radius: 14.4,
        opacity: 1,
        color: 'rgba(255,0,0,1.0)',
        dashArray: '',
        lineCap: 'butt',
        lineJoin: 'miter',
        weight: 1.0,
        fill: true,
        fillOpacity: 1,
        fillColor: 'rgba(255,0,0,1.0)',
        interactive: true,
    }
}

var layer_Form_Pengaduan_Jalan_Rusak_3; // Declare globally

function initializeLayer() {
    map.createPane('pane_Form_Pengaduan_Jalan_Rusak_3');
    map.getPane('pane_Form_Pengaduan_Jalan_Rusak_3').style.zIndex = 403;
    map.getPane('pane_Form_Pengaduan_Jalan_Rusak_3').style['mix-blend-mode'] = 'normal';
    
    layer_Form_Pengaduan_Jalan_Rusak_3 = new L.geoJson.multiStyle(json_Form_Pengaduan_Jalan_Rusak_3, {
        attribution: '',
        interactive: true,
        dataVar: 'json_Form_Pengaduan_Jalan_Rusak_3',
        layerName: 'layer_Form_Pengaduan_Jalan_Rusak_3',
        pane: 'pane_Form_Pengaduan_Jalan_Rusak_3',
        onEachFeature: pop_Form_Pengaduan_Jalan_Rusak_3,
            pointToLayers: [function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.shapeMarker(latlng, style_Form_Pengaduan_Jalan_Rusak_3_0(feature));
            },function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.shapeMarker(latlng, style_Form_Pengaduan_Jalan_Rusak_3_1(feature));
            },
        ]});
    
    bounds_group.addLayer(layer_Form_Pengaduan_Jalan_Rusak_3);
    map.addLayer(layer_Form_Pengaduan_Jalan_Rusak_3);
}

var osmGeocoder = new L.Control.Geocoder({
    collapsed: true,
    position: 'topleft',
    text: 'Search',
    title: 'Search for a place'
});

osmGeocoder.on('markgeocode', function(e) {
    var bbox = e.geocode.bbox;
    var poly = L.polygon([
        bbox.getSouthEast(),
        bbox.getSouthWest(),
        bbox.getNorthWest(),
        bbox.getNorthEast()
    ]);
    map.fitBounds(poly.getBounds(), {maxZoom: 17});
    map.closePopup();
});

osmGeocoder.addTo(map);

document.getElementsByClassName('leaflet-control-geocoder-icon')[0].className += ' fa fa-search';
document.getElementsByClassName('leaflet-control-geocoder-icon')[0].title = 'Search for a place';

// Add zoom to layer button
var zoomToLayerControl = L.control({position: 'topleft'});
zoomToLayerControl.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
    div.innerHTML = '<a href="#" title="Zoom to Titik Jalan Rusak" style="background-color:#fff;border:1px solid #ccc;border-radius:4px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;" onclick="zoomToTitikJalanRusak();return false;">üéØ</a>';
    div.style.backgroundColor = 'white';
    return div;
};
zoomToLayerControl.addTo(map);

// Function to zoom to layer bounds
function zoomToTitikJalanRusak() {
    if (layer_Form_Pengaduan_Jalan_Rusak_3 && layer_Form_Pengaduan_Jalan_Rusak_3.getBounds().isValid()) {
        map.fitBounds(layer_Form_Pengaduan_Jalan_Rusak_3.getBounds(), {padding: [50, 50]});
        console.log('Zoomed to Titik Jalan Rusak layer');
    } else {
        alert('Layer data not available yet. Please wait for data to load.');
    }
}

var overlaysTree = [
    {label: '<img src="legend/Form_Pengaduan_Jalan_Rusak_3.png" /> Titik Jalan Rusak', layer: layer_Form_Pengaduan_Jalan_Rusak_3},
    {label: "OpenStreetMap", layer: layer_OpenStreetMap_2, radioGroup: 'bm' },
    {label: "ESRI", layer: layer_ESRI_1, radioGroup: 'bm' },
    {label: "Google Satellite Hybrid", layer: layer_GoogleSatelliteHybrid_0, radioGroup: 'bm' },
]

var lay = L.control.layers.tree(null, overlaysTree, {
    collapsed: true,
});
lay.addTo(map);
setBounds();

var mapDiv = document.getElementById('map');
var row = document.createElement('div');
row.className="row";
row.id="all";
row.style.height = "100%";
var col1 = document.createElement('div');
col1.className="col9";
col1.id = "mapWindow";
col1.style.height = "100%";
col1.style.flex = "1";
var splitter = document.createElement('div');
splitter.id = "splitter";
var col2 = document.createElement('div');
col2.className="col3";
col2.id = "menu";
col2.style.flex = "0 0 20%";
mapDiv.parentNode.insertBefore(row, mapDiv);
document.getElementById("all").appendChild(col1);
document.getElementById("all").appendChild(splitter);
document.getElementById("all").appendChild(col2);
col1.appendChild(mapDiv)

setTimeout(function() {
    if (map && typeof map.invalidateSize === 'function') {
        map.invalidateSize();
        map.fitBounds([[-2.1544686141569516,115.37721551829694],[-2.1435672853948917,115.42201173480657]]);
    }
}, 200);

// Set sidebar title and description
col2.innerHTML = '<div style="padding:12px;font-family:Arial, sans-serif;color:#222">\
    <h3>Peta Kerusakan Jalan</h3>\
</div>';

var Filters = {"Skala Prioritas": "int"};

function filterFunc() {
  map.eachLayer(function(lyr){
  if ("options" in lyr && "dataVar" in lyr["options"]){
    features = this[lyr["options"]["dataVar"]].features.slice(0);
    try{
      for (key in Filters){
        keyS = key.replace(/[^a-zA-Z0-9_]/g, "")
        if (Filters[key] == "str" || Filters[key] == "bool"){
          var selection = [];
          var options = document.getElementById("sel_" + keyS).options
          for (var i=0; i < options.length; i++) {
            if (options[i].selected) selection.push(options[i].value);
          }
            try{
              if (key in features[0].properties){
                for (i = features.length - 1;
                  i >= 0; --i){
                  if (selection.indexOf(
                  features[i].properties[key])<0
                  && selection.length>0) {
                  features.splice(i,1);
                  }
                }
              }
            } catch(err){
          }
        }
        if (Filters[key] == "int"){
          sliderVals =  document.getElementById(
            "div_" + keyS).noUiSlider.get();
          try{
            if (key in features[0].properties){
            for (i = features.length - 1; i >= 0; --i){
              if (parseInt(features[i].properties[key])
                  < sliderVals[0]
                  || parseInt(features[i].properties[key])
                  > sliderVals[1]){
                    features.splice(i,1);
                  }
                }
              }
            } catch(err){
            }
          }
      }
    } catch(err){
    }
  this[lyr["options"]["layerName"]].clearLayers();
  this[lyr["options"]["layerName"]].addData(features);
  }
  })
}

// Create filter slider container
document.getElementById("menu").appendChild(document.createElement("div"));
var div_SkalaPrioritas = document.createElement("div");
div_SkalaPrioritas.id = "div_SkalaPrioritas";
div_SkalaPrioritas.className = "slider";
document.getElementById("menu").appendChild(div_SkalaPrioritas);

var lab_SkalaPrioritas = document.createElement('div');
lab_SkalaPrioritas.innerHTML  = 'Skala Prioritas: <span id="val_SkalaPrioritas"></span>';
lab_SkalaPrioritas.className = 'filterlabel';
document.getElementById("menu").appendChild(lab_SkalaPrioritas);

var reset_SkalaPrioritas = document.createElement('div');
reset_SkalaPrioritas.innerHTML = 'clear filter';
reset_SkalaPrioritas.className = 'filterlabel';
reset_SkalaPrioritas.onclick = function() {
    sel_SkalaPrioritas.noUiSlider.reset();
};
document.getElementById("menu").appendChild(reset_SkalaPrioritas);

// Create search section
var searchSection = document.createElement('div');
searchSection.style.cssText = 'padding:12px;margin-top:20px;border-top:1px solid #ddd;font-family:Arial, sans-serif;color:#222;';
searchSection.innerHTML = '\
    <h3 style="font-size: 14px; margin-top: 0;">üîç Cari Submission ID</h3>\
    <input type="text" id="submissionIdSearch" placeholder="Masukkan Submission ID" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">\
    <button id="searchButton" style="background: #004ba8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; width: 100%; transition: background 0.3s;" onmouseover="this.style.background=\'#003580\'" onmouseout="this.style.background=\'#004ba8\'">üîç Cari</button>\
    <div id="searchMessage" style="margin-top: 8px; color: red; font-size: 12px; display: none;"></div>\
';
document.getElementById("menu").appendChild(searchSection);

// Create form section below search
var formSection = document.createElement('div');
formSection.style.cssText = 'padding:12px;margin-top:20px;border-top:1px solid #ddd;font-family:Arial, sans-serif;color:#222;';
formSection.innerHTML = '\
    <h3 style="font-size: 14px; margin-top: 0;">üìù Pengaduan Kerusakan Jalan</h3>\
    <label style="font-weight: bold; display: block; margin-bottom: 8px;">Tambah Data Baru</label>\
    <button style="background: #004ba8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; width: 100%; transition: background 0.3s;" onmouseover="this.style.background=\'#003580\'" onmouseout="this.style.background=\'#004ba8\'" onclick="window.open(\'https://form.jotform.com/253162999499479\', \'_blank\')">üìù Buka Form Pengaduan</button>\
';
document.getElementById("menu").appendChild(formSection);

// Create feedback link section at the bottom
var feedbackSection = document.createElement('div');
feedbackSection.style.cssText = 'padding:12px;margin-top:20px;border-top:1px solid #ddd;font-family:Arial, sans-serif;color:#222;text-align:center;';
feedbackSection.innerHTML = '\
    <a href="https://forms.gle/Buo2tXrUaXFttrxr6" target="_blank" style="color: #004ba8; text-decoration: none; font-size: 12px; font-weight: bold;">üëâüèªTekan Saya Jika Anda Mempunyai Tanggapan Terkait Website iniüëàüèª</a>\
';
document.getElementById("menu").appendChild(feedbackSection);

// Initialize slider
var sel_SkalaPrioritas = document.getElementById('div_SkalaPrioritas');
noUiSlider.create(sel_SkalaPrioritas, {
    connect: true,
    start: [1, 5],
    step: 1,
    format: wNumb({
        decimals: 0,
    }),
    range: {
    min: 1,
    max: 5
    }
});

sel_SkalaPrioritas.noUiSlider.on('update', function (values) {
    val_SkalaPrioritas = document.getElementById('val_SkalaPrioritas');
    val_SkalaPrioritas.innerHTML = values.join(' - ');
    filterFunc()
});

// Add search functionality
document.getElementById('searchButton').addEventListener('click', function() {
    searchSubmissionId();
});

document.getElementById('submissionIdSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchSubmissionId();
    }
});

function searchSubmissionId() {
    var searchId = document.getElementById('submissionIdSearch').value.trim();
    var messageDiv = document.getElementById('searchMessage');
    
    if (!searchId) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = 'Mohon masukkan Submission ID';
        messageDiv.style.color = 'orange';
        return;
    }
    
    if (!layer_Form_Pengaduan_Jalan_Rusak_3 || !json_Form_Pengaduan_Jalan_Rusak_3.features) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = 'Data belum dimuat. Silakan tunggu sebentar.';
        messageDiv.style.color = 'orange';
        return;
    }
    
    var found = false;
    json_Form_Pengaduan_Jalan_Rusak_3.features.forEach(function(feature, index) {
        if (feature.properties['Submission ID'] && feature.properties['Submission ID'].toString().trim() === searchId) {
            // Zoom to the feature
            var latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
            map.setView(latlng, 18); // Zoom level 18 for close view
            
            // Find the layer and open popup
            layer_Form_Pengaduan_Jalan_Rusak_3.eachLayer(function(layer) {
                if (layer.feature === feature) {
                    layer.openPopup();
                }
            });
            
            found = true;
            messageDiv.style.display = 'none';
            return;
        }
    });
    
    if (!found) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = 'Mohon maaf, tidak ada ditemukan ID yang sesuai';
        messageDiv.style.color = 'red';
    }
}

// Initialize data loading
window.addEventListener('DOMContentLoaded', init);

// Resizable sidebar functionality
var splitter = document.getElementById('splitter');
var menu = document.getElementById('menu');
var mapWindow = document.getElementById('mapWindow');
var isResizing = false;
var startX, startWidth;

function startResize(e) {
    isResizing = true;
    startX = e.clientX || e.touches[0].clientX;
    startWidth = menu.offsetWidth;
    document.body.style.cursor = 'ew-resize';
    document.body.style.userSelect = 'none';
    document.body.style.touchAction = 'none';
}

function doResize(e) {
    if (!isResizing) return;
    var clientX = e.clientX || e.touches[0].clientX;
    var dx = clientX - startX;
    var newWidth = startWidth - dx;
    var containerWidth = document.getElementById('all').offsetWidth;
    var minWidth = window.innerWidth <= 768 ? 150 : 200; // Smaller min width on mobile
    var maxWidth = containerWidth - (window.innerWidth <= 768 ? 150 : 200); // Smaller min map width on mobile
    if (newWidth < minWidth) newWidth = minWidth;
    if (newWidth > maxWidth) newWidth = maxWidth;
    menu.style.flex = '0 0 ' + newWidth + 'px';
    if (map) map.invalidateSize(); // Refresh map size
}

function stopResize() {
    if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        document.body.style.touchAction = '';
    }
}

// Mouse events
splitter.addEventListener('mousedown', startResize);
document.addEventListener('mousemove', doResize);
document.addEventListener('mouseup', stopResize);

// Touch events for mobile
splitter.addEventListener('touchstart', startResize, { passive: false });
document.addEventListener('touchmove', doResize, { passive: false });
document.addEventListener('touchend', stopResize);
        </script>
    </body>
</html>
